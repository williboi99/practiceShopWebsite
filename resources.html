<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neff Enterprises Tool Suite - Resources</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#1f2937', // Gray-800
                        'accent': '#059669', // Vibrant Emerald Green
                        // Old nav colors removed as we are now using Tailwind's slate/amber classes
                        'active-yellow': '#f59e0b', 
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better mobile experience */
        body {
            background-color: #f3f4f6;
            /* Removed padding-top: 64px; as we handle spacing on the main content div now */
        }
        .card {
            /* Adjusted shadow for the individual tool containers */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Style for custom radio buttons/checkboxes */
        .configuration-group input[type="radio"] {
            display: none; /* Hide default radio input */
        }
        .configuration-group .custom-radio-label {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .configuration-group .custom-radio-label:hover {
             border-color: #d1d5db; /* Slightly darker gray border on hover */
        }
        
        .configuration-group .custom-radio-label:active {
            transform: scale(0.98);
        }
        /* --- Final Checked State (Very Dark Gray Fill + Solid Black Border) --- */
        .configuration-group input[type="radio"]:checked + .custom-radio-label {
            /* 1. Use a solid black border for strong visual feedback (2px matches default) */
            border-color: #000000; 
            border-width: 2px;
            
            /* 2. Keep the dark fill and white text for high contrast (Using primary-dark) */
            background-color: '#1f2937'; 
            color: #ffffff; 
            
            /* 3. Add a more obvious outer shadow */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); 
        }
        .configuration-group input[type="radio"]:checked + .custom-radio-label span {
            color: #ffffff; 
        }
    </style>
</head>
<body class="font-sans min-h-screen">
    
    
<header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            
<h1 class="text-3xl font-extrabold tracking-tight">
                <a href="index.html" class="text-amber-500 hover:text-amber-400 transition duration-150 ease-in-out">
                    Neff Enterprises
                </a>
            </h1>
            
<button id="menu-toggle" class="lg:hidden p-2 rounded-lg hover:bg-slate-700 transition duration-150 ease-in-out" aria-label="Toggle menu">
                
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
            
<nav class="hidden lg:flex space-x-6 text-lg font-medium">
                
<a href="resources.html" class="bg-amber-500 hover:bg-amber-400 text-slate-900 font-semibold transition duration-150 ease-in-out py-2 px-3 rounded-md">Resources</a>
                <a href="newCabinets.html" class="hover:text-amber-400 transition duration-150 ease-in-out py-2 px-3 rounded-md">New Cabinets</a>
                <a href="cabinetCostTool.html" class="hover:text-amber-400 transition duration-150 ease-in-out py-2 px-3 rounded-md">
                    Rebuild Price Calculator
                </a>
            </nav>
        </div>
        
<div id="menu-content" class="hidden lg:hidden bg-slate-800 border-t border-slate-700">
            <nav class="flex flex-col p-4 space-y-2">
                
<a href="resources.html" class="block bg-amber-500 hover:bg-amber-400 text-slate-900 rounded-lg p-3 transition duration-150 ease-in-out font-semibold">Resources</a>
                <a href="newCabinets.html" class="block text-white hover:bg-slate-700 rounded-lg p-3 transition duration-150 ease-in-out">New Cabinets</a>
                <a href="cabinetCostTool.html" class="block text-white hover:bg-slate-700 rounded-lg p-3 transition duration-150 ease-in-out">
                    Rebuild Price Calculator
                </a>
            </nav>
        </div>
    </header>

    
<div class="p-4 flex justify-center items-start pt-16">
        <div class="w-full max-w-4xl space-y-6">
            
            
<div class="bg-white rounded-xl shadow-xl">
                
<div id="visualizer-header" class="p-6 cursor-pointer flex justify-between items-center bg-gray-100 rounded-t-xl hover:bg-gray-200 transition duration-150">
                    <h1 class="text-2xl font-bold text-primary-dark">Cabinetry Visualizer</h1>
                    
<svg id="visualizer-icon" class="w-6 h-6 text-gray-700 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                
<div id="visualizer-content" class="hidden p-6">
                    <p class="text-gray-700 mb-6">Upload your kitchen photo, a reference for the cabinet door style, and your desired color to visualize your new cabinetry! "AIzaSyAJEfrkGEaeYn14Zwil7dHnPQuEZfOqsg4"</p>
                    
                    
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        
<div class="space-y-6">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Your References</h2>
                            
                            <!-- 0. API KEY INPUT (NEW) -->
                            <div class="input-group">
                                <label for="api-key-input" class="block text-lg font-medium text-gray-700 mb-2">Gemini API Key (Required)</label>
                                <input type="password" id="api-key-input" placeholder="Paste your Gemini API key here (sk-...)"
                                       class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-lg">
                                <p class="text-sm text-gray-500 mt-1">This key connects to the visualization model. It is not stored.</p>
                            </div>
                            
                            <!-- 1. KITCHEN PHOTO UPLOAD/CAMERA INPUT -->
                            <div class="input-group">
                                <label class="block text-lg font-medium text-gray-700 mb-2">Upload Kitchen Photo</label>
                                
                                <div class="flex space-x-3">
                                    <!-- Hidden Input -->
                                    <input type="file" id="kitchen-image-input" accept="image/*" class="hidden" onchange="handleFileChange(this)">
                                    
                                    <!-- Take Photo Button (Camera Symbol) -->
                                    <button type="button" 
                                            onclick="document.getElementById('kitchen-image-input').setAttribute('capture', 'environment'); document.getElementById('kitchen-image-input').click();" 
                                            class="p-3 bg-accent hover:bg-green-700 text-white rounded-lg transition duration-150 shadow-md flex-shrink-0 flex items-center justify-center w-1/4" 
                                            title="Take Photo">
                                        <!-- Camera Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                            <circle cx="12" cy="13" r="3"/>
                                        </svg>
                                    </button>
                                    
                                    <!-- Choose File Button -->
                                    <button type="button" 
                                            onclick="document.getElementById('kitchen-image-input').removeAttribute('capture'); document.getElementById('kitchen-image-input').click();" 
                                            class="flex-grow bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-sm">
                                        Choose File
                                    </button>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-1" id="kitchen-image-file-name">No file selected.</p>
                            </div>

                            <!-- 2. DOOR STYLE UPLOAD/CAMERA INPUT (UPDATED) -->
                            <div class="input-group">
                                <label class="block text-lg font-medium text-gray-700 mb-2">Cabinet Door Style Reference (Image or Text)</label>
                                
                                <div class="flex space-x-3 mb-2">
                                    <!-- Hidden Input -->
                                    <input type="file" id="door-style-input" accept="image/*" class="hidden" onchange="handleFileChange(this)">
                                    
                                    <!-- Take Photo Button (Camera Symbol) -->
                                    <button type="button" 
                                            onclick="document.getElementById('door-style-input').setAttribute('capture', 'environment'); document.getElementById('door-style-input').click();" 
                                            class="p-3 bg-accent hover:bg-green-700 text-white rounded-lg transition duration-150 shadow-md flex-shrink-0 flex items-center justify-center w-1/4" 
                                            title="Take Photo">
                                        <!-- Camera Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                            <circle cx="12" cy="13" r="3"/>
                                        </svg>
                                    </button>
                                    
                                    <!-- Choose File Button -->
                                    <button type="button" 
                                            onclick="document.getElementById('door-style-input').removeAttribute('capture'); document.getElementById('door-style-input').click();" 
                                            class="flex-grow bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-sm">
                                        Choose File
                                    </button>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-1 mb-2" id="door-style-image-file-name">No door style image selected, use text description below.</p>
                                
                                <!-- NEW TEXT DESCRIPTION FOR DOOR STYLE -->
                                <textarea id="door-style-text-description" rows="3" placeholder="e.g., 'traditional shaker style', 'modern slab door with integrated handle', 'beadboard cottage style'" class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-lg"></textarea>
                            </div>

                            <!-- 3. COLOR REFERENCE UPLOAD/CAMERA INPUT -->
                            <div class="input-group">
                                <label class="block text-lg font-medium text-gray-700 mb-2">Color Reference (Image or Text)</label>
                                
                                <div class="flex space-x-3 mb-2">
                                    <!-- Hidden Input -->
                                    <input type="file" id="color-image-input" accept="image/*" class="hidden" onchange="handleFileChange(this)">
                                    
                                    <!-- Take Photo Button (Camera Symbol) -->
                                    <button type="button" 
                                            onclick="document.getElementById('color-image-input').setAttribute('capture', 'environment'); document.getElementById('color-image-input').click();" 
                                            class="p-3 bg-accent hover:bg-green-700 text-white rounded-lg transition duration-150 shadow-md flex-shrink-0 flex items-center justify-center w-1/4" 
                                            title="Take Photo">
                                        <!-- Camera Icon -->
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                                            <circle cx="12" cy="13" r="3"/>
                                        </svg>
                                    </button>
                                    
                                    <!-- Choose File Button -->
                                    <button type="button" 
                                            onclick="document.getElementById('color-image-input').removeAttribute('capture'); document.getElementById('color-image-input').click();" 
                                            class="flex-grow bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-sm">
                                        Choose File
                                    </button>
                                </div>
                                
                                <p class="text-sm text-gray-500 mt-1 mb-2" id="color-image-file-name">No color image selected, use text description below.</p>
                                
                                <textarea id="color-text-description" rows="3" placeholder="e.g., 'a deep matte navy blue', 'light sage green', 'classic off-white with a hint of warmth'" class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-lg"></textarea>
                            </div>
                            
                            <button id="generate-visual-button" class="w-full bg-accent hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-xl transition duration-150 ease-in-out shadow-lg">
                                Generate Kitchen Visualization
                            </button>
                        </div>

                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Your New Kitchen Preview</h2>
                            <div id="visualizer-output" class="bg-gray-100 p-4 rounded-lg border border-gray-200 flex justify-center items-center min-h-[300px]">
                                <p id="visualizer-placeholder" class="text-gray-500 text-center">Upload images and describe your color, then click "Generate" to see your new kitchen!</p>
                                <img id="generated-kitchen-image" src="" alt="Generated Kitchen Visualization" class="hidden max-w-full h-auto rounded-lg shadow-md">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
<div class="bg-white rounded-xl shadow-xl">
                
<div id="cut-list-header" class="p-6 cursor-pointer flex justify-between items-center bg-gray-100 rounded-t-xl hover:bg-gray-200 transition duration-150">
                    <h1 class="text-2xl font-bold text-primary-dark">Euro Cabinet Cut List Generator</h1>
                    
<svg id="cut-list-icon" class="w-6 h-6 text-gray-700 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                
<div id="cut-list-content" class="hidden p-6">
                    
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
<div class="space-y-6">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Cabinet Specifications</h2>
                            
<div class="input-group mb-4">
                                <label for="material-thickness" class="block text-lg font-medium text-gray-700 mb-1">Material Thickness (T)</label>
                                <select id="material-thickness" class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                                    <option value="0.75" selected>3/4" (0.75 in)</option>
                                    <option value="0.625">5/8" (0.625 in)</option>
                                </select>
                                
</div>
                            
<div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="box-height" class="block text-lg font-medium text-gray-700 mb-1">Cabinet Height (A)</label>
                                    
<input type="number" id="box-height" min="0" step="0.01" placeholder="34.5"
                                                class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                    <p class="text-sm text-gray-500 mt-1">Overall height of the box.</p>
                                </div>
                                <div class="input-group">
                                    <label for="face-height" class="block text-lg font-medium text-gray-700 mb-1">Face Height (B)</label>
                                    
<input type="number" id="face-height" min="0" step="0.01" placeholder="30.5"
                                                class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                    <p class="text-sm text-gray-500 mt-1">Height of the face/door/drawer.</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="box-depth" class="block text-lg font-medium text-gray-700 mb-1">Cabinet Depth (C)</label>
                                    
<input type="number" id="box-depth" min="0" step="0.01" placeholder="24.0"
                                                class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                    <p class="text-sm text-gray-500 mt-1">Standard 24 or 21 inches.</p>
                                </div>
                                <div class="input-group">
                                    <label for="box-width" class="block text-lg font-medium text-gray-700 mb-1">Cabinet Width (D)</label>
                                    
<input type="number" id="box-width" min="0" step="0.01" placeholder="36.0"
                                                class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                    <p class="text-sm text-gray-500 mt-1">Overall width (e.g., 36 inches).</p>
                                </div>
                            </div>
                            
                            
<div class="configuration-group border-t pt-6 space-y-2">
                                <label class="block text-xl font-semibold text-accent mb-2">Cabinet Configuration</label>
                                
                                <label class="custom-radio-label">
                                    <input type="radio" name="cabinet-type" value="door_drawer" id="config-door-drawer" checked>
                                    <span class="ml-3 text-lg font-medium text-gray-800">Door + Drawer</span>
                                </label>
                                
                                <label class="custom-radio-label">
                                    <input type="radio" name="cabinet-type" value="full_door" id="config-full-door">
                                    
<span class="ml-3 text-lg font-medium text-gray-800">Full Height Doors / Sink Base</span>
                                </label>
                                
                                <label class="custom-radio-label">
                                    <input type="radio" name="cabinet-type" value="drawer_bank" id="config-drawer-bank">
                                    <span class="ml-3 text-lg font-medium text-gray-800">Drawer Bank</span>
                                </label>
                            </div>
                        </div>
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Calculated Cut List</h2>
                            
                            
<div id="results-container" class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-accent">
                                    <h3 class="text-lg font-bold text-primary-dark">Sides (2x)</h3>
                                    <p class="text-2xl font-extrabold text-accent" id="cut-side-dims">0" x 0"</p>
                                </div>
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-blue-500">
                                    <h3 class="text-lg font-bold text-primary-dark">Bottom (1x)</h3>
                                    <p class="text-2xl font-extrabold text-blue-500" id="cut-bottom-dims-actual">0" x 0"</p>
                                </div>
                                
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-indigo-500">
                                    <h3 class="text-lg font-bold text-primary-dark" id="stretcher-count-title">Stretchers (5x)</h3>
                                    <p class="text-2xl font-extrabold text-indigo-500" id="cut-stretcher-dims">0" x 0"</p>
                                </div>
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-red-500">
                                    <h3 class="text-lg font-bold text-primary-dark">Back Panel (1x)</h3>
                                    <p class="text-2xl font-extrabold text-red-500" id="cut-back-dims">0" x 0.00"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        
<p class="text-sm text-gray-500 text-center"></p>
                    </div>
                </div>
            </div>
            
            
<div class="bg-white rounded-xl shadow-xl">
                
<div id="drawer-box-cut-list-header" class="p-6 cursor-pointer flex justify-between items-center bg-gray-100 rounded-t-xl hover:bg-gray-200 transition duration-150">
                    <h1 class="text-2xl font-bold text-primary-dark">Drawer Box Cut List Generator</h1>
                    
<svg id="drawer-box-cut-list-icon" class="w-6 h-6 text-gray-700 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                
<div id="drawer-box-cut-list-content" class="hidden p-6">
                    <p class="text-lg text-red-600 font-semibold text-center bg-red-100 p-3 rounded-lg mb-6 shadow-inner">
                        Be sure to dado a 1/4" x 1/4" slit in the edge pieces to slide the 1/4" bottom.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Drawer Box Dimensions (in)</h2>
                            <div class="input-group">
                                <label for="drawer-box-width" class="block text-lg font-medium text-gray-700 mb-1">Overall Width</label>
                                
<input type="number" id="drawer-box-width" min="0" step="0.01" placeholder="18.0"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                <p class="text-sm text-gray-500 mt-1">External width of the finished drawer box.</p>
                            </div>
                            <div class="input-group">
                                <label for="drawer-box-depth" class="block text-lg font-medium text-gray-700 mb-1">Overall Depth (Length)</label>
                                
<input type="number" id="drawer-box-depth" min="0" step="0.01" placeholder="21.0"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                <p class="text-sm text-gray-500 mt-1">External depth/length of the finished drawer box.</p>
                            </div>
                            <div class="input-group">
                                <label for="drawer-box-height" class="block text-lg font-medium text-gray-700 mb-1">Overall Height</label>
                                
<input type="number" id="drawer-box-height" min="0" step="0.01" placeholder="6.0"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                <p class="text-sm text-gray-500 mt-1">External height of the finished drawer box.</p>
                            </div>
                        </div>
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Drawer Box Cut List</h2>
                            
                            
<div class="space-y-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-accent">
                                    <h3 class="text-lg font-bold text-primary-dark">Sides (2x)</h3>
                                    <p class="text-2xl font-extrabold text-accent" id="drawer-side-dims">0" x 0"</p>
                                </div>
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-blue-500">
                                    <h3 class="text-lg font-bold text-primary-dark">Front & Back (2x)</h3>
                                    <p class="text-2xl font-extrabold text-blue-500" id="drawer-front-back-dims">0" x 0"</p>
                                </div>
                                
                                
<div class="bg-white p-3 rounded-lg shadow-md border-l-4 border-indigo-500">
                                    <h3 class="text-lg font-bold text-primary-dark">1/4" Bottom (1x)</h3>
                                    <p class="text-2xl font-extrabold text-indigo-500" id="drawer-bottom-dims">0" x 0"</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
<div class="bg-white rounded-xl shadow-xl">
                
<div id="drawer-cost-header" class="p-6 cursor-pointer flex justify-between items-center bg-gray-100 rounded-t-xl hover:bg-gray-200 transition duration-150">
                    <h1 class="text-2xl font-bold text-primary-dark">Drawer Rebuild Cost Calculator</h1>
                    
<svg id="drawer-cost-icon" class="w-6 h-6 text-gray-700 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                
<div id="drawer-cost-content" class="hidden p-6">
                    
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Drawer Specifications (in)</h2>
                            <div class="input-group">
                                <label for="drawer-width" class="block text-lg font-medium text-gray-700 mb-1">Drawer Width</label>
                                
<input type="number" id="drawer-width" min="0" step="0.1" placeholder="18.0"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                <p class="text-sm text-gray-500 mt-1">Width of the drawer box (in).</p>
                            </div>
                            <div class="input-group">
                                <label for="drawer-depth" class="block text-lg font-medium text-gray-700 mb-1">Drawer Depth (or Length)</label>
                                
<input type="number" id="drawer-depth" min="0" step="0.1" placeholder="21.0"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                <p class="text-sm text-gray-500 mt-1">Depth/Length of the drawer box (in).</p>
                            </div>
                            
                            
<div class="input-group pt-4 border-t border-gray-200">
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" id="drawer-new-glides" 
                                           class="form-checkbox h-5 w-5 text-accent rounded focus:ring-accent border-gray-300">
                                    <span class="text-lg font-medium text-gray-700">Needs new set of glides</span>
                                </label>
                            </div>
                        </div>
                        
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Calculated Cost</h2>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-bold text-primary-dark">Estimated Cost</h3>
                                <p class="text-4xl font-extrabold text-green-600 mt-1" id="calculated-cost">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
<div class="bg-white rounded-xl shadow-xl">
                
<div id="faceframe-repair-header" class="p-6 cursor-pointer flex justify-between items-center bg-gray-100 rounded-t-xl hover:bg-gray-200 transition duration-150">
                    <h1 class="text-2xl font-bold text-primary-dark">Faceframe Repair Cost Calculator</h1>
                    
<svg id="faceframe-repair-icon" class="w-6 h-6 text-gray-700 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                
                
<div id="faceframe-repair-content" class="hidden p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Repair Details</h2>
                            
<div class="input-group">
                                <label for="faceframe-sections" class="block text-lg font-medium text-gray-700 mb-1">Sections Damaged</label>
                                
<input type="number" id="faceframe-sections" min="0" step="1" placeholder="1"
                                            class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-xl">
                                
<p class="text-sm text-gray-500 mt-1">Number of distinct sections (stiles/rails) requiring repair.</p>
                            </div>
                            
<div id="damage-level-container" class="pt-4 border-t border-gray-200">
                                
</div>
                            
<div class="input-group pt-4">
                                <label class="flex items-center space-x-3">
                                    <input type="checkbox" id="faceframe-remade" class="form-checkbox h-5 w-5 text-accent rounded focus:ring-accent border-gray-300">
                                    <span class="text-lg font-medium text-gray-700">
                                        Whole faceframe will need remade / sanded + refinished 
                                        <span class="text-sm text-gray-500 font-normal">(1 face, 48 inches or less.)</span> 
                                    </span>
                                </label>
                            </div>
                        </div>
                        
                        
<div class="space-y-4">
                            <h2 class="text-xl font-semibold text-accent border-b pb-2">Estimated Total</h2>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-bold text-primary-dark">Estimated Repair Cost</h3>
                                <p class="text-4xl font-extrabold text-green-600 mt-1" id="faceframe-calculated-cost">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
</div>
    </div>
    <script>
        // --- CONSTANTS ---
        // Max file size (5MB) to prevent large payloads from crashing the Cloud Function proxy
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; 


        /**
         * Function to display the selected file name for visual confirmation and enforce size limit.
         */
        const handleFileChange = (inputElement) => {
            const fileNameId = inputElement.id.replace('-input', '-file-name');
            const fileNameElement = document.getElementById(fileNameId);
            
            if (!fileNameElement) {
                console.error(`Missing element for file name display: ${fileNameId}`);
                return;
            }

            if (inputElement.files && inputElement.files.length > 0) {
                const file = inputElement.files[0];
                const fileName = file.name;

                // --- 1. Size Check ---
                if (file.size > MAX_FILE_SIZE_BYTES) {
                    fileNameElement.textContent = `ERROR: File too large. Max size is 5MB.`;
                    fileNameElement.classList.remove('text-green-600', 'font-medium', 'text-base', 'text-gray-500');
                    fileNameElement.classList.add('text-red-500', 'font-semibold', 'text-sm');
                    
                    // Clear the file input immediately to prevent failed submit
                    inputElement.value = null; 
                    return; 
                }

                // --- 2. Success State UI Update ---
                fileNameElement.textContent = `Selected: ${fileName}`;
                fileNameElement.classList.remove('text-gray-500', 'text-red-500', 'font-semibold', 'text-sm');
                fileNameElement.classList.add('text-green-600', 'font-medium', 'text-base'); 
                
                // Visual feedback transition
                fileNameElement.style.transition = 'opacity 0.2s';
                fileNameElement.style.opacity = '0.5';
                setTimeout(() => { fileNameElement.style.opacity = '1'; }, 50);

            } else {
                // --- Reset State UI Update ---
                const isColorInput = inputElement.id.includes('color');
                const isDoorStyleInput = inputElement.id.includes('door-style'); // NEW Check for door style
                
                let defaultText = 'No file selected.';

                if (isColorInput) {
                    defaultText = 'No color image selected, use text description below.';
                } else if (isDoorStyleInput) { 
                    defaultText = 'No door style image selected, use text description below.';
                }

                fileNameElement.textContent = defaultText;
                fileNameElement.classList.remove('text-green-600', 'font-medium', 'text-base', 'text-red-500', 'font-semibold');
                fileNameElement.classList.add('text-gray-500', 'text-sm');
                
                // Ensure transition is removed on reset
                fileNameElement.style.transition = 'none';
                fileNameElement.style.opacity = '1';
            }
        };

        /**
         * Helper function to convert decimal inches to a mixed fraction string (e.g., 34.9375 -> "34 15/16").
         * Rounds to the nearest specified denominator (default 16th of an inch).
         */
        const decimalToFraction = (decimal, denominator = 16) => {
            if (isNaN(decimal)) return "0";
            // Ensure positive number for fraction calculation
            const absDecimal = Math.abs(decimal); 
            
            const integerPart = Math.floor(absDecimal);
            let fractionalPart = absDecimal - integerPart;
            if (fractionalPart === 0) return decimal.toFixed(2); // Return original if exact integer
            
            let numerator = Math.round(fractionalPart * denominator);
            
            // Handle rounding up to the next inch
            if (numerator === denominator) {
                return (decimal < 0 ? '-' : '') + (integerPart + 1).toString();
            }
            
            const gcd = (a, b) => (b ? gcd(b, a % b) : a);
            const divisor = gcd(numerator, denominator);
            numerator /= divisor;
            denominator /= divisor;
            
            let fractionString = `${numerator}/${denominator}`;
            let sign = decimal < 0 ? '-' : '';

            if (integerPart === 0) {
                // If the original number was negative and near zero (e.g. -0.5), it returns "-1/2"
                // If the original number was positive and near zero (e.g. 0.5), it returns "1/2"
                return sign + fractionString;
            } else {
                return sign + `${integerPart} ${fractionString}`;
            }
        };

        const updateResult = (id, dim1, dim2) => {
            const el = document.getElementById(id);
            if (el) {
                // Ensure dimensions are positive before display (as per woodworking practice)
                const safeDim1 = parseFloat(dim1.toString().replace(/[^0-9\.\/\s-]/g, ''));
                const safeDim2 = parseFloat(dim2.toString().replace(/[^0-9\.\/\s-]/g, ''));

                if (safeDim1 < 0 || safeDim2 < 0) {
                    el.textContent = "Error: Negative Dimension";
                    el.classList.add('text-red-500');
                    el.classList.remove('text-accent', 'text-blue-500', 'text-indigo-500');
                } else {
                    el.textContent = `${dim1}" x ${dim2}"`;
                    // Reset styling to default colors based on the section
                    const defaultColorClass = 
                        id.includes('side') ? 'text-accent' : 
                        id.includes('front-back') ? 'text-blue-500' :
                        id.includes('bottom') ? 'text-indigo-500' : 
                        'text-gray-900';
                    el.classList.remove('text-red-500', 'text-accent', 'text-blue-500', 'text-indigo-500');
                    el.classList.add(defaultColorClass);
                }
            }
        };

        // --- Toggle Function for Collapsible Sections ---
        const toggleSection = (headerId, contentId, iconId) => {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            if (content && icon) {
                const isHidden = content.classList.toggle('hidden');
                
                // Rotate the icon 180 degrees when visible
                if (isHidden) {
                    icon.classList.remove('rotate-180');
                } else {
                    icon.classList.add('rotate-180');
                }
            }
        };

        // --- Core Calculation Logic for Euro Cabinet Cut List ---
        const calculateCutList = () => {
            // Get raw input values
            const T_str = document.getElementById('material-thickness').value;
            
            // Use logical OR to default to 0.0 if value is empty/null/NaN
            const BoxH_raw = parseFloat(document.getElementById('box-height').value || 0.0); // A (Cabinet Height)
            const FaceH_raw = parseFloat(document.getElementById('face-height').value || 0.0); // B (Face/Door Height)
            
            const D_raw = parseFloat(document.getElementById('box-depth').value || 0.0); // C (Depth)
            const W_raw = parseFloat(document.getElementById('box-width').value || 0.0); // D (Overall Width)
            const T = parseFloat(T_str); // Thickness: 0.75 or 0.625
            
            // Constants for frameless construction
            const DADO_DEPTH = 0.25; // 1/4" dado depth for recessing the bottom
            const BACK_WIDTH_OFFSET = 0.4375; // 7/16"
            
            if (isNaN(BoxH_raw) || isNaN(FaceH_raw) || isNaN(D_raw) || isNaN(W_raw) || isNaN(T) || BoxH_raw <= 0 || D_raw <= 0 || W_raw <= 0) {
                // Keep the fields at 0.00 if input is invalid
                updateResult('cut-side-dims', '0', '0');
                updateResult('cut-bottom-dims-actual', '0', '0'); 
                updateResult('cut-stretcher-dims', '0', '0'); 
                updateResult('cut-back-dims', '0', '0.00');
                return;
            }
            
            // --- Determine Cabinet Type and Stretcher Count ---
            let stretcher_count = 5; // Default for Door + Drawer
            const selectedConfig = document.querySelector('input[name="cabinet-type"]:checked')?.value;
            
            if (selectedConfig === 'full_door') {
                stretcher_count = 4;
            } else if (selectedConfig === 'drawer_bank') {
                stretcher_count = 6;
            } else {
                // 'door_drawer' or default
                stretcher_count = 5;
            }
            
            // Update Stretcher count label
            const stretcherTitle = document.getElementById('stretcher-count-title');
            if (stretcherTitle) {
                stretcherTitle.textContent = `Stretchers (${stretcher_count}x)`;
            }

            // --- 1. Calculate Final Dimensions ---
            
            // Sides (2x) - Cut: Height x Depth
            const side_height = decimalToFraction(BoxH_raw);
            const side_depth = decimalToFraction(D_raw);
            
            // Common Width for Bottom and Stretchers: (Overall Width - 2T)
            const common_inner_width = W_raw - (2 * T); 
            
            // Bottom Deduction Logic: Cabinet Depth (C) - Material Thickness (T) - Dado Depth
            const bottom_deduction = T + DADO_DEPTH;
            
            // Bottom (1x) - Cut: Width (Fractional) x Depth (Fractional)
            const bottom_width = decimalToFraction(common_inner_width);
            const bottom_depth_raw = D_raw - bottom_deduction;
            const bottom_depth = decimalToFraction(bottom_depth_raw); 
            
            // CALCULATED STRETCHER DEPTH: Cabinet Height (A) - Face Height (B)
            const STRETCHER_DEPTH_RAW = BoxH_raw - FaceH_raw;
            
            // Stretchers (Nx) - Cut: Width (Fractional) x Depth (Fractional)
            const stretcher_width = decimalToFraction(common_inner_width); 
            const stretcher_depth = decimalToFraction(STRETCHER_DEPTH_RAW); 
            
            // Back Panel (1x)
            // Back Panel Width = Bottom/Stretchers Width + 7/16" (0.4375)
            const back_width_decimal = common_inner_width + BACK_WIDTH_OFFSET; 
            const back_height_decimal = FaceH_raw;
            
            // --- 2. Update UI ---
            updateResult('cut-side-dims', side_height, side_depth);
            updateResult('cut-bottom-dims-actual', bottom_width, bottom_depth);
            updateResult('cut-stretcher-dims', stretcher_width, stretcher_depth);
            const back_width_fraction = decimalToFraction(back_width_decimal);
            const back_height_fraction = decimalToFraction(back_height_decimal);
            updateResult('cut-back-dims', back_width_fraction, back_height_fraction);
        };

        // --- Core Calculation Logic for Drawer Box Cut List (NEW FUNCTION) ---
        const calculateDrawerBoxCutList = () => {
            // Use logical OR to default to 0.0 if value is empty/null/NaN
            const W_raw = parseFloat(document.getElementById('drawer-box-width').value || 0.0); // Width
            const D_raw = parseFloat(document.getElementById('drawer-box-depth').value || 0.0); // Depth (Length)
            const H_raw = parseFloat(document.getElementById('drawer-box-height').value || 0.0); // Height
            
            const DRAWER_BOTTOM_DEDUCTION = 0.5625; // 9/16"

            // Check if any input is missing or results in non-positive dimensions
            if (isNaN(W_raw) || isNaN(D_raw) || isNaN(H_raw) || W_raw <= 0 || D_raw <= 0 || H_raw <= 0 || W_raw <= DRAWER_BOTTOM_DEDUCTION || D_raw <= DRAWER_BOTTOM_DEDUCTION) {
                // Clear outputs if inputs are invalid or zero/negative or too small
                updateResult('drawer-side-dims', '0', '0');
                updateResult('drawer-front-back-dims', '0', '0');
                updateResult('drawer-bottom-dims', '0', '0');
                return;
            }
            
            // 1. Sides (2x): Depth x Height
            const side_dim1 = decimalToFraction(D_raw);
            const side_dim2 = decimalToFraction(H_raw);
            updateResult('drawer-side-dims', side_dim1, side_dim2);
            
            // 2. Front and Back (2x): (Width - 1") x Height
            const front_back_width_raw = W_raw - 1.0;
            const front_back_dim1 = decimalToFraction(front_back_width_raw);
            const front_back_dim2 = decimalToFraction(H_raw);
            updateResult('drawer-front-back-dims', front_back_dim1, front_back_dim2);

            // 3. 1/4" Bottom (1x): (Width - 9/16") x (Depth - 9/16")
            const bottom_depth_raw = D_raw - DRAWER_BOTTOM_DEDUCTION;
            const bottom_width_raw = W_raw - DRAWER_BOTTOM_DEDUCTION;

            // Width is typically listed first for the bottom panel
            const bottom_dim1 = decimalToFraction(bottom_width_raw); 
            const bottom_dim2 = decimalToFraction(bottom_depth_raw); 
            updateResult('drawer-bottom-dims', bottom_dim1, bottom_dim2);
        };
        
        // --- Calculation Logic for Drawer Rebuild Cost ---
        const calculateDrawerCost = () => {
            const W_raw = parseFloat(document.getElementById('drawer-width').value || 0.0); // Width
            const D_raw = parseFloat(document.getElementById('drawer-depth').value || 0.0); // Depth (Length)
            const glidesChecked = document.getElementById('drawer-new-glides').checked; // NEW: Checkbox status
            
            const costEl = document.getElementById('calculated-cost');
            const MAX_COST = 130.00;
            const GLIDES_COST = 25.00; // Updated from $40.00 to $25.00
            
            // Use 0.00 if input is invalid or non-positive
            if (isNaN(W_raw) || W_raw <= 0 || isNaN(D_raw) || D_raw <= 0) {
                // If dimensions are invalid, cost is 0 unless glides are needed
                let initialCost = glidesChecked ? GLIDES_COST : 0.00;
                costEl.textContent = `$${initialCost.toFixed(2)}`;
                return;
            }

            // Formula: Price = (Length + Width) * 3
            const calculatedBaseCost = (W_raw + D_raw) * 3;
            
            // 1. Apply maximum cap of $130.00 to the base rebuild cost
            let finalCost = Math.min(calculatedBaseCost, MAX_COST); 
            
            // 2. Add glides cost after the cap, if checked
            if (glidesChecked) {
                finalCost += GLIDES_COST; 
            }
            
            costEl.textContent = `$${finalCost.toFixed(2)}`;
        };
        
        // Utility function to generate the selector options HTML
        const getDamageOptionHTML = (index) => {
            // Full descriptive text restored for options
            return `
                <div>
                    <label for="damage-level-${index}" class="block text-lg font-medium text-gray-700 mb-1">Section ${index}</label>
                    <select id="damage-level-${index}" 
                            class="faceframe-damage-level-selector block w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent text-base transition duration-150">
                        <option value="touch-up" data-cost="20" selected>Simple touch-up (marker/putty)</option>
                        
<option value="small-break" data-cost="50">Small break (epoxy / glue+clamp)</option>
                        
<option value="replaced" data-cost="100">Needs replaced</option>
                    </select>
                </div>
            `;
        };
        
        // --- Renders Dynamic Damage Severity Selectors ---
        const renderDamageLevelSelectors = () => {
            const sectionsInput = document.getElementById('faceframe-sections');
            const container = document.getElementById('damage-level-container');
            if (!sectionsInput || !container) return;
            const sections = parseInt(sectionsInput.value || '0'); // Safely default to 0 if blank

            // Updated logic: Allow 0 sections, and cap at 10. Default to 0 if input is invalid/empty.
            const numSections = Math.max(0, Math.min(10, sections || 0)); 

            // Wrap selectors in a responsive grid container: 1 column on mobile, 2 columns on sm+ screens
            let html = '<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">';
            for (let i = 1; i <= numSections; i++) {
                html += getDamageOptionHTML(i);
            }
            html += '</div>';
            container.innerHTML = html;
            
            // Attach event listeners to all newly created selects
            document.querySelectorAll('.faceframe-damage-level-selector').forEach(select => {
                select.addEventListener('change', calculateFaceframeCost);
            });
            
            // Re-run calculation after rendering new inputs
            calculateFaceframeCost(); 
        };

        // --- Calculation Logic for Faceframe Repair Cost (Updated) ---
        const calculateFaceframeCost = () => {
            const remade = document.getElementById('faceframe-remade').checked;
            const costEl = document.getElementById('faceframe-calculated-cost');
            const sections = parseInt(document.getElementById('faceframe-sections').value || '0'); // Safely default to 0
            
            // PRICE UPDATED FROM $250.00 TO $300.00
            const FLAT_REFINISH_COST = 300.00; 
            const MAX_COST = 999.00; 

            // If sections is 0 or less, cost is 0 unless remade is checked
            if (sections <= 0 && !remade) {
                costEl.textContent = "$0.00";
                return;
            }
            
            let totalCost = 0;

            // Priority Logic: If whole faceframe remade is checked, lock the price at $300.00
            if (remade) {
                totalCost = FLAT_REFINISH_COST;
            } else {
                // If not remade, calculate damage cost based on individual sections
                let damageCost = 0;
                
                // 1. Calculate damage cost by summing up all dynamic selectors
                document.querySelectorAll('.faceframe-damage-level-selector').forEach(select => {
                    // Read the cost directly from the data-cost attribute of the selected option
                    const selectedOption = select.options[select.selectedIndex];
                    const sectionCost = parseFloat(selectedOption.getAttribute('data-cost'));
                    if (!isNaN(sectionCost)) {
                        damageCost += sectionCost;
                    }
                });
                
                totalCost = damageCost;
            }
            
            // Apply mock max cap (helpful if non-remade damage cost is extremely high)
            if (totalCost > MAX_COST) {
                totalCost = MAX_COST;
            }
            costEl.textContent = `$${totalCost.toFixed(2)}`;
        };


        // --- New Helper Functions for Image Generation ---

        /**
         * Helper to read file to base64, with robust error checking for the resulting Data URL.
         * @param {File} file 
         * @returns {Promise<{data: string, mimeType: string}|null>}
         */
        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            if (!file) {
                return resolve(null); 
            }
            const reader = new FileReader();
            
            reader.onload = () => {
                const dataUrl = reader.result;
                const parts = dataUrl.split(',');
                
                if (parts.length !== 2) {
                    // If the Data URL doesn't have the expected "data:mime/type;base64,data" format
                    console.error("FileReader result is not a standard Data URL format. Result:", dataUrl.substring(0, 100) + '...');
                    return reject(new Error("File reader failed: Invalid Data URL format produced."));
                }
                
                const base64String = parts[1];
                
                // Add a check for zero-length base64 string
                if (!base64String || base64String.length === 0) {
                     return reject(new Error("File reader failed: Produced an empty Base64 string (check file content)."));
                }

                resolve({
                    data: base64String,
                    mimeType: file.type
                });
            };
            
            reader.onerror = (error) => {
                console.error("FileReader error occurred:", error);
                reject(new Error(`File read error: ${error.message || 'Unknown error'}`));
            };
            
            reader.readAsDataURL(file);
        });

        // Implementation of exponential backoff for retries
        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            let lastError;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // For non-OK responses (like 429, 500, etc.), we might retry
                    if (response.status === 429 || response.status >= 500) {
                        lastError = new Error(`HTTP error ${response.status}: ${response.statusText}`);
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    } else {
                        // For other errors (4xx), don't retry, just throw
                        const errorBody = await response.text();
                        // CRITICAL: Log 4xx error body for debugging the API payload issue
                        console.error("Non-retriable API Error Body:", errorBody);
                        throw new Error(`API error ${response.status}: ${errorBody}`);
                    }
                } catch (error) {
                    lastError = error;
                    // Only delay if it was a network error or explicitly marked for retry logic
                    if (error.name !== 'AbortError' && i < maxRetries - 1) { 
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                    continue; // Retry or break if max retries reached
                }
            }
            throw lastError || new Error("API call failed after maximum retries.");
        };


        // --- Refactored New Cabinetry Visualizer Logic ---
        const handleVisualizeClick = async () => {
            
            // --- NEW: Key Retrieval and API URL Construction ---
            const apiKey = document.getElementById('api-key-input').value.trim();
            const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent";
            const apiUrl = `${API_BASE_URL}?key=${apiKey}`; // Directly use the user-provided key

            // Updated IDs to match the new hidden inputs
            const kitchenImageInput = document.getElementById('kitchen-image-input');
            const doorStyleInput = document.getElementById('door-style-input');
            const doorStyleTextDescription = document.getElementById('door-style-text-description').value.trim(); // NEW
            const colorImageInput = document.getElementById('color-image-input');
            const colorTextDescription = document.getElementById('color-text-description').value.trim();

            const generatedKitchenImage = document.getElementById('generated-kitchen-image');
            const visualizerPlaceholder = document.getElementById('visualizer-placeholder');
            const visualizerOutput = document.getElementById('visualizer-output');
            const generateButton = document.getElementById('generate-visual-button');

            
            if (!generatedKitchenImage || !visualizerPlaceholder || !visualizerOutput || !generateButton) {
                console.error("Critical visualization DOM elements not found.");
                return;
            }
            
            // UI Feedback: Start Loading
            generateButton.disabled = true;
            generateButton.textContent = 'Generating... Please wait.';
            visualizerPlaceholder.classList.remove('hidden');
            generatedKitchenImage.classList.add('hidden');
            generatedKitchenImage.src = ''; // Clear previous image

            // --- 1. Initial Input Validation ---
            const kitchenImageFile = kitchenImageInput.files[0];
            const doorStyleFile = doorStyleInput.files[0];
            const colorImageFile = colorImageInput.files[0];

            // Check if API key is provided
            if (!apiKey) {
                visualizerPlaceholder.textContent = 'ERROR: Please provide your Gemini API Key in the field above.';
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Kitchen Visualization';
                return;
            }

            // UPDATED VALIDATION LOGIC: Check for Kitchen Photo + (Door Style Image OR Text) + (Color Image OR Text)
            if (!kitchenImageFile || (!doorStyleFile && !doorStyleTextDescription) || (!colorImageFile && !colorTextDescription)) {
                visualizerPlaceholder.textContent = 'ERROR: Please provide a Kitchen Photo, a Door Style Reference (image or text), AND a Color Reference (image or text). Ensure files are under 5MB.';
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Kitchen Visualization';
                return;
            }

            // --- 2. File to Base64 Conversion (Asynchronously) ---
            let kitchenBase64, doorStyleBase64 = null, colorBase64 = null;

            try {
                visualizerPlaceholder.textContent = 'Uploading and processing images...';
                
                kitchenBase64 = await fileToBase64(kitchenImageFile);
                
                // Only process door style image if a file was selected
                if (doorStyleFile) { 
                    doorStyleBase64 = await fileToBase64(doorStyleFile);
                }
                
                // Only process color image if a file was selected
                if (colorImageFile) {
                    colorBase64 = await fileToBase64(colorImageFile); 
                }

                // --- CRITICAL HARDENING: Check that required files were converted successfully ---
                if (!kitchenBase64 || !kitchenBase64.data || kitchenBase64.data.length === 0) {
                    throw new Error("Failed to process Kitchen Photo. File data is missing or empty.");
                }
                
                // If an image was selected but failed to convert, throw error for door style reference (unless text is present)
                if (doorStyleFile && (!doorStyleBase64 || !doorStyleBase64.data || doorStyleBase64.data.length === 0)) {
                    if (!doorStyleTextDescription) {
                        throw new Error("Failed to process Door Style Image, and no text description was provided.");
                    }
                    doorStyleBase64 = null; // Clear failed base64 to prevent adding it to parts
                }

                // If an optional color image was selected, but conversion failed, warn and ignore it.
                if (colorImageFile && (!colorBase64 || !colorBase64.data || colorBase64.data.length === 0)) {
                     console.warn("Color image selected but failed to convert to Base64 (data was empty). Proceeding with text description only.");
                     // Set colorBase64 to null to ensure it's not added to parts with no data
                     colorBase64 = null; 
                }


                // --- 3. Construct API Payload ---
                
                // Determine the prompt components based on provided inputs and the image order in 'parts'
                const styleInput = doorStyleBase64 
                    ? "the second uploaded image" 
                    : `the text description: "${doorStyleTextDescription}"`;
                    
                // If doorStyleBase64 is present, color image is the 3rd. If not, color image is the 2nd.
                const colorImagePosition = doorStyleBase64 ? "third" : "second"; 
                
                const colorInput = colorBase64 
                    ? `the ${colorImagePosition} uploaded image` 
                    : `the text description: "${colorTextDescription}"`;

                // The text prompt should be last in the parts array.
                const userQuery = `Remodel the primary kitchen image (first image) by changing the cabinet doors and color. 
                Use the door style defined by ${styleInput}. 
                Use the new cabinet color defined by ${colorInput}.
                Output a photorealistic visualization of the remodeled kitchen. Only change the cabinets.`;

                // The parts array will hold the images and the final prompt
                const parts = [];
                
                // 1. Add the primary kitchen image (Base Image)
                parts.push({
                    inlineData: {
                        mimeType: kitchenBase64.mimeType,
                        data: kitchenBase64.data
                    }
                });
                
                // 2. Add the door style reference image (ONLY if successfully converted/provided)
                if (doorStyleBase64) {
                    parts.push({
                        inlineData: {
                            mimeType: doorStyleBase64.mimeType,
                            data: doorStyleBase64.data
                        }
                    }
                    );
                }
                
                // 3. Add the optional color reference image (only if successfully converted)
                if (colorBase64) {
                    parts.push({
                        inlineData: {
                            mimeType: colorBase64.mimeType,
                            data: colorBase64.data
                        }
                    }
                    );
                }
                
                // 4. Add the final text prompt
                parts.push({ text: userQuery });

                // CRITICAL: Validation check for minimum parts (1 kitchen image + at least 1 text prompt)
                if (parts.length < 2) { 
                     throw new Error(`Internal Error: Payload assembly failed. Found only ${parts.length} parts (must have at least Kitchen Image + Text Prompt).`);
                }
                
                console.log("Final payload parts count:", parts.length);
                
                // This payload structure is what the API expects
                const payload = {
                    // Contents is an array containing a single message object (role + parts)
                    contents: [{ role: "user", parts: parts }], 
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                };
                
                visualizerPlaceholder.textContent = 'Generating visualization via Gemini API (this may take up to 30 seconds)...';

                // --- 4. Call the Gemini API with Retry (using the URL constructed with the user's key) ---
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                const base64Part = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                const base64Data = base64Part?.inlineData?.data;

                // --- 5. Display Result ---
                if (base64Data) {
                    const imageUrl = `data:${base64Part.inlineData.mimeType};base64,${base64Data}`;
                    generatedKitchenImage.src = imageUrl;
                    visualizerPlaceholder.classList.add('hidden');
                    generatedKitchenImage.classList.remove('hidden');
                } else {
                    // Fallback to text part if it exists
                    const textPart = result?.candidates?.[0]?.content?.parts?.find(p => p.text)?.text || 
                                     JSON.stringify(result, null, 2); // Show full response for better debugging
                    visualizerPlaceholder.textContent = `IMAGE GENERATION FAILED. Response: ${textPart}`;
                    visualizerPlaceholder.classList.remove('hidden');
                    generatedKitchenImage.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('API or File Reading Error:', error);
                // Display the specific error message to the user
                visualizerPlaceholder.textContent = `CRITICAL ERROR: ${error.message}. Please check your API Key, ensure image files are under 5MB, and are valid image formats.`;
                visualizerPlaceholder.classList.remove('hidden');
                generatedKitchenImage.classList.add('hidden');
            } finally {
                // UI Feedback: Stop Loading
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Kitchen Visualization';
            }
        };


        // --- Mobile Menu Toggle Logic (UPDATED) ---
        const setupMobileMenu = () => {
            const toggleButton = document.getElementById('menu-toggle');
            const menuContent = document.getElementById('menu-content');
            
            if (toggleButton && menuContent) {
                toggleButton.addEventListener('click', function() {
                    menuContent.classList.toggle('hidden');
                    // Removed document.body.classList.toggle('overflow-hidden'); for simplicity
                });
            }
        };

        // --- DOM Load and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupMobileMenu(); // Setup the new mobile menu toggle
            
            // --- Toggle Listeners ---
            document.getElementById('visualizer-header')?.addEventListener('click', () => {
                toggleSection('visualizer-header', 'visualizer-content', 'visualizer-icon');
            });
            document.getElementById('cut-list-header')?.addEventListener('click', () => {
                toggleSection('cut-list-header', 'cut-list-content', 'cut-list-icon');
            });
            // NEW DRAWER BOX CUT LIST TOGGLE
            document.getElementById('drawer-box-cut-list-header')?.addEventListener('click', () => {
                toggleSection('drawer-box-cut-list-header', 'drawer-box-cut-list-content', 'drawer-box-cut-list-icon');
            });
            document.getElementById('drawer-cost-header')?.addEventListener('click', () => {
                toggleSection('drawer-cost-header', 'drawer-cost-content', 'drawer-cost-icon');
            });
            // New Faceframe Repair Toggle Listener
            document.getElementById('faceframe-repair-header')?.addEventListener('click', () => {
                toggleSection('faceframe-repair-header', 'faceframe-repair-content', 'faceframe-repair-icon');
            });

            // Listener for the new visualizer button
            document.getElementById('generate-visual-button')?.addEventListener('click', handleVisualizeClick);


            // Listeners for calculating cut lists and costs
            const cutListInputs = ['material-thickness', 'box-height', 'face-height', 'box-depth', 'box-width'];
            cutListInputs.forEach(id => {
                document.getElementById(id)?.addEventListener('input', calculateCutList);
            });
            document.querySelectorAll('input[name="cabinet-type"]').forEach(radio => {
                radio.addEventListener('change', calculateCutList);
            });
            
            const drawerBoxInputs = ['drawer-box-width', 'drawer-box-depth', 'drawer-box-height'];
            drawerBoxInputs.forEach(id => {
                document.getElementById(id)?.addEventListener('input', calculateDrawerBoxCutList);
            });

            const drawerCostInputs = ['drawer-width', 'drawer-depth', 'drawer-new-glides'];
            drawerCostInputs.forEach(id => {
                document.getElementById(id)?.addEventListener('input', calculateDrawerCost);
                document.getElementById(id)?.addEventListener('change', calculateDrawerCost);
            });

            document.getElementById('faceframe-sections')?.addEventListener('input', () => {
                renderDamageLevelSelectors();
                calculateFaceframeCost();
            });
            document.getElementById('faceframe-remade')?.addEventListener('change', calculateFaceframeCost);


            // Initial calculation to populate fields on load
            // Note: Calculations will run, but inputs will be blank as requested.
            calculateCutList();
            calculateDrawerBoxCutList(); 
            calculateDrawerCost();
            renderDamageLevelSelectors(); 
        });
    </script>
</body>
</html>
