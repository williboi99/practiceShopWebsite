<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinetry Quote Calculator - Print Ready (Refined, Responsive)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#1f2937', // Gray-800
                        'accent': '#059669', // Vibrant Emerald Green
                        'nav-dark': '#0f172a', 
                        'nav-text': '#f3f4f6',
                        'active-yellow': '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better mobile experience and printing */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding-top: 0px; 
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Hide the receipt view on screen by default */
        #print-receipt {
            display: none;
            min-height: 10vh;
        }
        
        /* --- PRINT STYLES for PDF Receipt --- */
        @media print {
            /* Hide the input form, print controls, and the main site header (#site-header) when printing */
            /* REMOVED generic 'header' from this list to allow the receipt's internal header to show. */
            #app-input, #print-controls {
                display: none !important;
            }
            
            /* Target the main site header specifically to hide it */
            header.bg-slate-900 {
                display: none !important;
            }

            body { 
                padding-top: 0; 
                background-color: white;
            }
            /* Make the receipt fill the page */
            #print-receipt {
                display: block !important;
                width: 100% !important;
                max-width: none !important;
                padding: 0;
                margin: 0;
                box-shadow: none !important;
                background-color: white !important;
                font-family: 'Inter', sans-serif;
                font-size: 10pt; 
            }
            /* Style to match the screenshot's receipt line items */
            .receipt-line-item {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 4px 0;
                border-bottom: 1px dashed #e5e7eb; /* Light dash for separation */
            }
            .receipt-section-header {
                font-size: 1.1rem; /* Slightly larger than line items */
                font-weight: 700;
                color: #1f2937;
                border-bottom: 3px solid #059669; /* Thick green line */
                padding-bottom: 5px;
                margin-bottom: 15px;
            }
            /* Force colors to print */
            .receipt-total-bar {
                background-color: #ecfdf5 !important; /* light green */
                border: 2px solid #059669 !important; /* Stronger green border */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Ensure text for prices prints black */
            .price-display {
                color: #1f2937 !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* RULE TO ENSURE DARK TEXT PRINTS BLACK (including company details) */
            .text-primary-dark { 
                color: #000000 !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Ensure the receipt's own header is NOT hidden */
            #print-receipt header {
                display: block !important;
            }
            /* END ADDITION/MODIFICATION */
            
            /* RUSH Fee styling */
            .is-rush-fee {
                background-color: #fef2f2 !important; 
                border-left: 4px solid #ef4444; 
                padding-left: 10px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Discount styling */
            .is-discount {
                background-color: #d1fae5 !important; 
                border-left: 4px solid #059669; 
                padding-left: 10px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            h1, h2, h3 { color: #1f2937 !important; }
        }
    </style>
</head>
<body class="font-sans min-h-screen">
    
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-tight text-amber-500">
                <a href="index.html" class="inline-block hover:text-amber-400 transition duration-150 ease-in-out">
                    Neff Enterprises
                </a>
            </h1>

            <button id="menu-toggle" class="lg:hidden p-2 rounded-lg hover:bg-slate-700 transition duration-150 ease-in-out" aria-label="Toggle menu">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>

            <nav class="hidden lg:flex space-x-6 text-lg font-medium items-center">
                <a href="resources.html" class="hover:text-amber-400 transition duration-150 ease-in-out py-2 px-3 rounded-md">Resources</a>
                <a href="newCabinets.html" class="hover:text-amber-400 transition duration-150 ease-in-out py-2 px-3 rounded-md">New Cabinets</a>
                <a href="cabinetCostTool.html" class="bg-amber-500 text-slate-900 font-bold px-3 py-1 rounded-lg hover:bg-amber-400 transition duration-150 ease-in-out">
                    Rebuild Price Calculator
                </a>
            </nav>
        </div>

        <div id="menu-content" class="hidden lg:hidden bg-slate-800 border-t border-slate-700">
            <nav class="flex flex-col p-4 space-y-2">
                <a href="resources.html" class="block text-white hover:bg-slate-700 rounded-lg p-3 transition duration-150 ease-in-out">Resources</a>
                <a href="newCabinets.html" class="block text-white hover:bg-slate-700 rounded-lg p-3 transition duration-150 ease-in-out">New Cabinets</a>
                <a href="cabinetCostTool.html" class="block bg-amber-500 text-slate-900 font-bold hover:bg-amber-400 rounded-lg p-3 transition duration-150 ease-in-out">
                    Rebuild Price Calculator
                </a>
            </nav>
        </div>
    </header>

    <div class="p-4 flex justify-center items-start mt-4">
        <div id="app-input" class="w-full max-w-lg lg:max-w-6xl bg-white rounded-xl p-6 card">
            <h1 class="text-3xl font-bold text-primary-dark mb-2 text-center">Cabinet Rebuild Quote</h1>
            <p class="text-center text-gray-500 mb-8">Enter details and quantities below to generate your printable quote.</p>
            
            <div id="job-details" class="space-y-4 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-primary-dark border-b pb-2 text-accent">Job Details</h2>
                
                <div class="job-input">
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Company</label>
                    <input type="text" id="company-name" placeholder="E.g., ABC Contractors" 
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                </div>
                
                <div class="job-input">
                    <label for="project-manager" class="block text-sm font-medium text-gray-700">Project Manager Name</label>
                    <input type="text" id="project-manager" placeholder="E.g., John Doe" 
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                </div>
                
                <div class="job-input">
                    <label for="job-name" class="block text-sm font-medium text-gray-700">Job Name/Number</label>
                    <input type="text" id="job-name" placeholder="E.g., 2024-001 or Jane Smith" 
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                </div>
                
                <div class="job-input">
                    <label for="job-address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" id="job-address" placeholder="123 Main St, Anytown, USA" 
                           class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                </div>

                <div class="job-input grid grid-cols-2 gap-4">
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-gray-700">Project Manager's Phone</label>
                        <input type="tel" id="client-phone" placeholder="(555) 555-5555" 
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                    </div>
                    <div>
                        <label for="job-date" class="block text-sm font-medium text-gray-700">Quote Date</label>
                        <input type="date" id="job-date" 
                               class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent">
                    </div>
                </div>
                
                <div class="job-input pt-4 border-t border-gray-200">
                    <label for="job-notes" class="block text-sm font-medium text-gray-700">Job Notes (Appears on Quote)</label>
                    <textarea id="job-notes" rows="3" placeholder="E.g., Client wants a smooth finish.
Job requires lead time of 6 weeks." 
                              class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent"></textarea>
                </div>
                
                <div class="job-input pt-4 border-t border-gray-200">
                    <div class="flex items-start mb-2">
                        <input type="checkbox" id="checkbox-rushed" 
                               class="mt-1 h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500" onchange="calculateTotal()">
                        <label for="checkbox-rushed" class="ml-3 block text-lg font-bold text-red-600">
                            RUSHED
                        </label>
                    </div>
                    <p class="text-sm text-red-700 italic font-medium -mt-1 p-2 bg-red-100 rounded-md">
                        Depending on the condition of the job, we can have it complete within 4 business days at an extra 50% cost. <span class="font-bold">This fee applies only to the core cabinetry lineal-foot items.</span>
                    </p>
                </div>
            </div>
            
            <div class="lg:grid lg:grid-cols-2 lg:gap-8">
                
                <div class="space-y-6 mb-8 lg:mb-0">
                    
                    <h2 class="text-xl font-bold text-accent pt-4 border-t border-gray-200">Cabinetry & Shelving</h2>

                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                            <label for="material-select" class="block text-sm font-medium text-gray-700 font-bold">Cabinet Box Material</label>
                            <select id="material-select" onchange="applyMaterialPricing()"
                                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent text-base font-semibold bg-white shadow-sm">
                                <option value="Hardrock Maple">Hardrock Maple</option>
                                <option value="White">White</option>
                                <option value="Almond">Almond</option>
                                <option value="Particle Board">Particle Board</option>
                                <option value="Plywood">Plywood</option>
                                <option value="Plywood (Stained Interior)">Plywood (Stained Interior)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="input-base" class="block text-lg font-medium text-gray-700 mb-1">Base</label>
                        <div class="flex items-center">
                            <input type="number" id="input-base" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-base" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $90 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-half-shelf" class="block text-lg font-medium text-gray-700 mb-1">Half-Depth Shelving</label>
                        <div class="flex items-center">
                            <input type="number" id="input-half-shelf" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-half-shelf" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $18 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="flex items-center justify-between mb-1">
                            <label for="input-base-install" class="block text-lg font-medium text-gray-700">Base with Installation</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="check-base-install" class="h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="updatePricesDisplay()">
                                <label for="check-base-install" class="ml-1 text-sm font-medium text-gray-600 select-none">Under Countertops</label>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="input-base-install" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-base-install" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $155 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-full-height" class="block text-lg font-medium text-gray-700 mb-1">Full Height</label>
                        <div class="flex items-center">
                            <input type="number" id="input-full-height" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-height" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $180 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-full-shelf" class="block text-lg font-medium text-gray-700 mb-1">Full-Depth Shelving</label>
                        <div class="flex items-center">
                            <input type="number" id="input-full-shelf" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-shelf" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $36 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="flex items-center justify-between mb-1">
                            <label for="input-full-height-install" class="block text-lg font-medium text-gray-700">Full Height with Installation</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="check-full-height-install" class="h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="updatePricesDisplay()">
                                <label for="check-full-height-install" class="ml-1 text-sm font-medium text-gray-600 select-none">Under Countertops</label>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="input-full-height-install" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-height-install" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $310 / ft
                            </span>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold text-accent mb-3">European Style (Faceless)</h3>
                    </div>

                    <div class="input-group">
                        <label for="input-base-european" class="block text-lg font-medium text-gray-700 mb-1">Base European</label>
                        <div class="flex items-center">
                            <input type="number" id="input-base-european" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-base-european" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $195 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="flex items-center justify-between mb-1">
                            <label for="input-base-european-install" class="block text-lg font-medium text-gray-700">Base European w/ Install</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="check-base-european-install" class="h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="updatePricesDisplay()">
                                <label for="check-base-european-install" class="ml-1 text-sm font-medium text-gray-600 select-none">Under Countertops</label>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="input-base-european-install" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-base-european-install" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $280 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-full-height-european" class="block text-lg font-medium text-gray-700 mb-1">Full Height European</label>
                        <div class="flex items-center">
                            <input type="number" id="input-full-height-european" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-height-european" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $285 / ft
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="flex items-center justify-between mb-1">
                            <label for="input-full-height-european-install" class="block text-lg font-medium text-gray-700">Full Height European w/ Install</label>
                            <div class="flex items-center">
                                <input type="checkbox" id="check-full-height-european-install" class="h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="updatePricesDisplay()">
                                <label for="check-full-height-european-install" class="ml-1 text-sm font-medium text-gray-600 select-none">Under Countertops</label>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" id="input-full-height-european-install" data-unit="ft" placeholder="0.0" min="0" step="0.5"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-height-european-install" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $435 / ft
                            </span>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">

                    <h2 class="text-xl font-bold text-accent pt-4 border-t border-gray-200 lg:border-t-0">Staining and Accessories</h2>

                    <div class="input-group p-3 bg-emerald-50 rounded-lg border border-emerald-200 space-y-2">
                        <p class="text-sm font-semibold text-gray-800">Select required matching services (<span class="font-bold">$150 per service</span>):</p>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="checkbox-stain-match" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="calculateTotal()">
                                <label for="checkbox-stain-match" class="ml-2 text-sm font-medium text-gray-700 select-none">Stain</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="checkbox-paint-match" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="calculateTotal()">
                                <label for="checkbox-paint-match" class="ml-2 text-sm font-medium text-gray-700 select-none">Paint</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="checkbox-lacquer-match" class="h-5 w-5 text-accent border-gray-300 rounded focus:ring-accent/70" onchange="calculateTotal()">
                                <label for="checkbox-lacquer-match" class="ml-2 text-sm font-medium text-gray-700 select-none">Lacquer</label>
                            </div>
                        </div>
                        <p id="match-fee-status" class="text-center font-bold text-red-600 text-sm pt-2 border-t border-emerald-300 hidden"></p>
                    </div>
                    
                    <div class="input-group p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="finished-material-select" class="block text-sm font-medium text-gray-700 font-bold">Finished Material</label>
                        <select id="finished-material-select"
                                class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent text-base font-semibold bg-white shadow-sm" onchange="calculateTotal()">
                            <option value="Maple">Maple</option>
                            <option value="Oak">Oak</option>
                            <option value="Cherry">Cherry</option>
                            <option value="Alder (clear)">Alder (clear)</option>
                            <option value="Alder (knotty)">Alder (knotty)</option>
                            <option value="Hickory">Hickory</option>
                            <option value="White">White</option>
                            <option value="MDF">MDF</option>
                            <option value="Almond">Almond</option>
                            <option value="Hardrock">Hardrock</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="input-base-skins" class="block text-lg font-medium text-gray-700 mb-1">Base/Wall Skins</label>
                        <div class="flex items-center">
                            <input type="number" id="input-base-skins" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-base-skins" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $85 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-full-skins" class="block text-lg font-medium text-gray-700 mb-1">Full Height Skin / Back Panel</label>
                        <div class="flex items-center">
                            <input type="number" id="input-full-skins" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-full-skins" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $170 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-toekick" class="block text-lg font-medium text-gray-700 mb-1">Toekick (8ft)</label>
                        <div class="flex items-center">
                            <input type="number" id="input-toekick" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-toekick" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $30 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-fillers" class="block text-lg font-medium text-gray-700 mb-1">Fillers</label>
                        <div class="flex items-center">
                            <input type="number" id="input-fillers" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-fillers" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $50 / PC
                            </span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="input-scribe" class="block text-lg font-medium text-gray-700 mb-1">Scribe (8ft)</label>
                        <div class="flex items-center">
                            <input type="number" id="input-scribe" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-scribe" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $35 / PC
                            </span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="input-batten" class="block text-lg font-medium text-gray-700 mb-1">Batten (36")</label>
                        <div class="flex items-center">
                            <input type="number" id="input-batten" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-batten" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $20 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-mid-scribe" class="block text-lg font-medium text-gray-700 mb-1">1-1/4" Scribe (8ft)</label>
                        <div class="flex items-center">
                            <input type="number" id="input-mid-scribe" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-mid-scribe" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $50 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-outside-scribe" class="block text-lg font-medium text-gray-700 mb-1">Outside Corner Scribe (8ft)</label>
                        <div class="flex items-center">
                            <input type="number" id="input-outside-scribe" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-outside-scribe" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $55 / PC
                            </span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="input-quarter-scribe" class="block text-lg font-medium text-gray-700 mb-1">Quarter-Round Scribe (8ft)</label>
                        <div class="flex items-center">
                            <input type="number" id="input-quarter-scribe" data-unit="PC" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-quarter-scribe" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $55 / PC
                            </span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="input-glides-set" class="block text-lg font-medium text-gray-700 mb-1">New Sets of Glides</label>
                        <div class="flex items-center">
                            <input type="number" id="input-glides-set" data-unit="SET" placeholder="0" min="0" step="1"
                                   class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-accent focus:border-accent text-xl transition duration-150">
                            <span id="display-glides-set" class="price-display p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-l-0 rounded-r-lg">
                                $25 / SET
                            </span>
                        </div>
                    </div>
                    
                    <div class="input-group pt-4 border-t border-gray-200">
                        <h3 class="block text-lg font-bold text-gray-700 mb-2">
                            New Lazy Susan Hardware
                        </h3>
                        
                        <p class="text-sm text-gray-500 mb-4 flex items-center justify-between sm:justify-start">
                            Replacement hardware for lazy susans.
                            <label for="radio-lazy-susan-none" class="ml-4 flex items-center text-gray-700 font-semibold cursor-pointer select-none">
                                <input type="radio" id="radio-lazy-susan-none" name="lazy-susan" value="none" checked
                                       class="h-5 w-5 text-gray-600 border-gray-300 rounded-full focus:ring-gray-500 mr-2" onchange="calculateTotal()">
                                None
                            </label>
                        </p>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            
                            <div class="flex-1 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-200 shadow-sm transition hover:shadow-md">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <input type="radio" id="radio-lazy-susan-wood" name="lazy-susan" value="wood"
                                               class="h-6 w-6 text-yellow-600 border-gray-300 rounded-full focus:ring-yellow-500" onchange="calculateTotal()">
                                        <label for="radio-lazy-susan-wood" class="ml-3 block text-base font-bold text-gray-800 select-none">
                                            Premium Wood Hardware
                                        </label>
                                    </div>
                                    <span id="display-lazy-susan-wood" class="price-display text-xl font-extrabold text-yellow-600">$500</span>
                                </div>
                            </div>

                            <div class="flex-1 p-4 bg-blue-50 rounded-lg border-2 border-blue-200 shadow-sm transition hover:shadow-md">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <input type="radio" id="radio-lazy-susan-plastic" name="lazy-susan" value="plastic"
                                               class="h-6 w-6 text-blue-600 border-gray-300 rounded-full focus:ring-blue-500" onchange="calculateTotal()">
                                        <label for="radio-lazy-susan-plastic" class="ml-3 block text-base font-bold text-gray-800 select-none">
                                            Standard Plastic Hardware
                                        </label>
                                    </div>
                                    <span id="display-lazy-susan-plastic" class="price-display text-xl font-extrabold text-blue-600">$200</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="custom-flat-rate-section" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-xl font-bold text-accent mb-4">Custom Flat Rate Items</h2>

                <div class="input-group">
                    <label for="input-faceframe-repair" class="block text-lg font-semibold text-red-600 mb-1">Faceframe Repair (Custom Price)</label>
                    <p class="text-xs text-gray-500 italic mb-2">Note: Grain, color, sheen, and grunge may vary when matching original material.</p>
                    <div class="flex items-center">
                        <span class="p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-r-0 rounded-l-lg">$</span>
                        <input type="number" id="input-faceframe-repair" placeholder="0.00" min="0" step="10"
                               class="flex-1 p-3 border border-red-300 focus:ring-red-400 focus:border-red-400 text-xl transition duration-150 font-bold">
                        <span class="p-3 bg-red-600 text-white text-base font-semibold border border-red-600 border-l-0 rounded-r-lg">
                            FLAT
                        </span>
                    </div>
                </div>
                
                <div class="input-group mt-6">
                    <label for="input-misc-custom" class="block text-lg font-semibold text-red-600 mb-1">Miscellaneous / Customization (Custom Price)</label>
                    <div class="flex items-center">
                        <span class="p-3 bg-gray-100 text-gray-600 text-base font-semibold border border-gray-300 border-r-0 rounded-l-lg">$</span>
                        <input type="number" id="input-misc-custom" placeholder="0.00" min="0" step="10"
                               class="flex-1 p-3 border border-red-300 focus:ring-red-400 focus:border-red-400 text-xl transition duration-150 font-bold">
                        <span class="p-3 bg-red-600 text-white text-base font-semibold border border-red-600 border-l-0 rounded-r-lg">
                            FLAT
                        </span>
                    </div>
                </div>

                <div class="input-group mt-2 p-3 border border-gray-300 rounded-lg">
                    <label for="input-misc-description" class="block text-sm font-medium text-gray-700 mb-1">Description for Custom Price</label>
                    <textarea id="input-misc-description" rows="2" placeholder="E.g., Install client-supplied hardware, custom floating shelf labor, special lighting."
                              class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-accent focus:border-accent"></textarea>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 p-4 bg-indigo-50 rounded-xl">
                <h2 class="text-xl font-bold text-indigo-700 mb-4">Payment Method</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label for="payment-invoice" class="flex items-center flex-1 p-3 bg-white border border-indigo-300 rounded-lg cursor-pointer transition hover:bg-indigo-100/50 select-none">
                        <input type="radio" id="payment-invoice" name="payment-method" value="Invoice" checked
                               class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="calculateTotal()">
                        <span class="ml-3 text-base font-semibold text-gray-800">Invoice / Card</span>
                    </label>
                    
                    <label for="payment-cash" class="flex items-center flex-1 p-3 bg-white border border-indigo-300 rounded-lg cursor-pointer transition hover:bg-indigo-100/50 select-none">
                        <input type="radio" id="payment-cash" name="payment-method" value="Cash"
                               class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="calculateTotal()">
                        <span class="ml-3 text-base font-semibold text-gray-800">Cash</span>
                    </label>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200" id="print-controls">
                <div id="quote-total" class="flex justify-between items-center bg-accent/10 p-4 rounded-xl">
                    <span class="text-xl font-semibold text-primary-dark">TOTAL ESTIMATED COST:</span>
                    <span id="total-cost" class="text-4xl font-extrabold text-accent">$0.00</span>
                </div>
                <div class="mt-4">
                    <button id="print-quote-btn" class="w-full p-3 text-lg font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                        Print Quote (Save PDF)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-receipt" class="w-full max-w-2xl mx-auto">
        </div>

    <script>
        // --- Mobile Menu Toggle Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const menuToggle = document.getElementById('menu-toggle');
            const menuContent = document.getElementById('menu-content');

            if (menuToggle && menuContent) {
                menuToggle.addEventListener('click', function() {
                    const isExpanded = menuContent.classList.contains('hidden');
                    if (isExpanded) {
                        menuContent.classList.remove('hidden');
                    } else {
                        menuContent.classList.add('hidden');
                    }
                });
            }
        });

        // --- DOM Elements ---
        const inputElements = document.querySelectorAll('#app-input input, #app-input select, #app-input textarea'); 
        const totalCostEl = document.getElementById('total-cost');
        const printBtn = document.getElementById('print-quote-btn');
        const jobDateInput = document.getElementById('job-date');
        const receiptContainer = document.getElementById('print-receipt');
        const matchFeeStatusEl = document.getElementById('match-fee-status');
        const materialSelect = document.getElementById('material-select');
        const finishedMaterialSelect = document.getElementById('finished-material-select');

        // --- Price Constants Definitions ---
        const UNDER_COUNTERTOP_ADJUSTMENT = 25; // Constant for the new $25 fee
        
        const DEFAULT_PRICES = {
            base: 90, halfShelf: 18, baseInstall: 155, fullHeight: 180, fullShelf: 36, fullHeightInstall: 310,
            baseEuropean: 195, baseEuropeanInstall: 280, fullHeightEuropean: 285, fullHeightEuropeanInstall: 435,
            baseSkins: 85, fullSkins: 170, toekick: 30, fillers: 50, matchFee: 150, scribe: 35,
            batten: 20, midScribe: 50, outsideCornerScribe: 55, quarterRoundScribe: 55, glidesSet: 25, 
            lazySusanWood: 500, lazySusanPlastic: 200
        };

        const PLYWOOD_OVERRIDE_PRICES = {
            base: 145, halfShelf: 29, baseInstall: 210, fullHeight: 288, fullShelf: 58, fullHeightInstall: 420,
            baseEuropean: 312, baseEuropeanInstall: 397, fullHeightEuropean: 456, fullHeightEuropeanInstall: 606
        };
        
        const PLYWOOD_STAINED_PRICES = {
            base: 185, halfShelf: 37, baseInstall: 250, fullHeight: 367, fullShelf: 74, fullHeightInstall: 500,
            baseEuropean: 398, baseEuropeanInstall: 483, fullHeightEuropean: 581, fullHeightEuropeanInstall: 731
        };

        let CURRENT_PRICES = {...DEFAULT_PRICES}; 

        // Map linking input IDs to price keys and display IDs
        const ITEM_MAP = [
            // Lineal Foot Items (These are the 'Cabinetry & Shelving' items, subject to RUSH fee)
            { id: 'input-base', priceKey: 'base', name: 'Base (Rebuild)', unit: 'ft', isLineal: true, displayId: 'display-base' },
            { id: 'input-half-shelf', priceKey: 'halfShelf', name: 'Half-Depth Shelving', unit: 'ft', isLineal: true, displayId: 'display-half-shelf' },
            // UPDATED: Added checkboxId for Under Countertops fee
            { 
                id: 'input-base-install', priceKey: 'baseInstall', name: 'Base w/ Installation', unit: 'ft', 
                isLineal: true, displayId: 'display-base-install', checkboxId: 'check-base-install' 
            },
            { id: 'input-full-height', priceKey: 'fullHeight', name: 'Full Height (Rebuild)', unit: 'ft', isLineal: true, displayId: 'display-full-height' },
            { id: 'input-full-shelf', priceKey: 'fullShelf', name: 'Full-Depth Shelving', unit: 'ft', isLineal: true, displayId: 'display-full-shelf' },
            // UPDATED: Added checkboxId for Under Countertops fee
            { 
                id: 'input-full-height-install', priceKey: 'fullHeightInstall', name: 'Full Height w/ Installation', unit: 'ft', 
                isLineal: true, displayId: 'display-full-height-install', checkboxId: 'check-full-height-install' 
            },
            { id: 'input-base-european', priceKey: 'baseEuropean', name: 'Base European (Faceless)', unit: 'ft', isLineal: true, displayId: 'display-base-european' },
            // UPDATED: Added checkboxId for Under Countertops fee
            { 
                id: 'input-base-european-install', priceKey: 'baseEuropeanInstall', name: 'Base European w/ Install', unit: 'ft', 
                isLineal: true, displayId: 'display-base-european-install', checkboxId: 'check-base-european-install' 
            },
            { id: 'input-full-height-european', priceKey: 'fullHeightEuropean', name: 'Full Height European (Faceless)', unit: 'ft', isLineal: true, displayId: 'display-full-height-european' },
            // UPDATED: Added checkboxId for Under Countertops fee
            { 
                id: 'input-full-height-european-install', priceKey: 'fullHeightEuropeanInstall', name: 'Full Height European w/ Install', unit: 'ft', 
                isLineal: true, displayId: 'display-full-height-european-install', checkboxId: 'check-full-height-european-install' 
            },
            
            // Accessory Items (Not subject to RUSH fee)
            { id: 'input-base-skins', priceKey: 'baseSkins', name: 'Base/Wall Skins', unit: 'PC', isLineal: false, displayId: 'display-base-skins' },
            { id: 'input-full-skins', priceKey: 'fullSkins', name: 'Full Height Skin / Back Panel', unit: 'PC', isLineal: false, displayId: 'display-full-skins' },
            { id: 'input-toekick', priceKey: 'toekick', name: 'Toekick (8ft)', unit: 'PC', isLineal: false, displayId: 'display-toekick' },
            { id: 'input-fillers', priceKey: 'fillers', name: 'Fillers', unit: 'PC', isLineal: false, displayId: 'display-fillers' },
            { id: 'input-scribe', priceKey: 'scribe', name: 'Scribe (8ft)', unit: 'PC', isLineal: false, displayId: 'display-scribe' },
            { id: 'input-batten', priceKey: 'batten', name: 'Batten (36")', unit: 'PC', isLineal: false, displayId: 'display-batten' }, 
            { id: 'input-mid-scribe', priceKey: 'midScribe', name: '1-1/4" Scribe (8ft)', unit: 'PC', isLineal: false, displayId: 'display-mid-scribe' },
            { id: 'input-outside-scribe', priceKey: 'outsideCornerScribe', name: 'Outside Corner Scribe (8ft)', unit: 'PC', isLineal: false, displayId: 'display-outside-scribe' },
            { id: 'input-quarter-scribe', priceKey: 'quarterRoundScribe', name: 'Quarter-Round Scribe (8ft)', unit: 'PC', isLineal: false, displayId: 'display-quarter-scribe' },
            { id: 'input-glides-set', priceKey: 'glidesSet', name: 'New Sets of Glides', unit: 'SET', isLineal: false, displayId: 'display-glides-set' }, 
        ];

        // --- Utility Functions ---
        const getValue = (id, isNumber = true) => {
            const el = document.getElementById(id);
            if (!el) return isNumber ? 0 : '';
            
            if (el.type === 'checkbox' || el.type === 'radio') {
                return el.checked;
            }

            if (isNumber) {
                const value = +el.value;
                return isNaN(value) ? 0 : value;
            }
            
            return el.value || '';
        };

        const formatCurrency = (amount) => `${(amount || 0).toFixed(2)}`;
        
        // --- Dynamic Pricing and Display Updates ---
        const updatePricesDisplay = () => {
            ITEM_MAP.forEach(item => {
                const spanEl = document.getElementById(item.displayId);
                if (spanEl && item.unit) {
                    // Check if a fixed price exists in CURRENT_PRICES (unadjusted base rate)
                    let price = CURRENT_PRICES[item.priceKey];
                    if (typeof price === 'number') {
                        // If this item has an "Under Countertops" checkbox, check if it's selected
                        if (item.checkboxId && getValue(item.checkboxId, false)) {
                            price += UNDER_COUNTERTOP_ADJUSTMENT;
                        }
                        // ********************************************
                        // FIX: Adding the '$' sign back to the display
                        // ********************************************
                        spanEl.textContent = `$${price.toFixed(0)} / ${item.unit}`;
                    }
                }
            });
            const woodDisplay = document.getElementById('display-lazy-susan-wood');
            if(woodDisplay) {
                woodDisplay.textContent = `$${CURRENT_PRICES.lazySusanWood.toFixed(0)}`; 
            }
            const plasticDisplay = document.getElementById('display-lazy-susan-plastic');
            if(plasticDisplay) {
                plasticDisplay.textContent = `$${CURRENT_PRICES.lazySusanPlastic.toFixed(0)}`; 
            }
            calculateTotal(); 
        };

        const applyMaterialPricing = () => {
            const selectedMaterial = materialSelect.value;
            if (selectedMaterial === 'Plywood') {
                CURRENT_PRICES = {...DEFAULT_PRICES, ...PLYWOOD_OVERRIDE_PRICES};
            } else if (selectedMaterial === 'Plywood (Stained Interior)') {
                CURRENT_PRICES = {...DEFAULT_PRICES, ...PLYWOOD_STAINED_PRICES};
            } else {
                CURRENT_PRICES = {...DEFAULT_PRICES};
            }
            updatePricesDisplay();
        };

        // --- Calculation & Receipt Generation Logic ---
        const calculateTotal = () => {
            let subtotal = 0; 
            let rushableSubtotal = 0; // Tracks only 'Cabinetry & Shelving' (Lineal items) for RUSH fee calculation
            let total = 0; 
            let breakdown = [];
            
            // Helper function for adding itemized costs
            const addItem = (item) => {
                const qty = getValue(item.id);
                // Start with the base rate from CURRENT_PRICES
                let rate = CURRENT_PRICES[item.priceKey]; 
                
                if (qty > 0 && typeof rate === 'number') {
                    let adjustment = 0;
                    
                    // Logic for Under Countertops Checkbox Adjustment
                    if (item.checkboxId && getValue(item.checkboxId, false)) {
                        adjustment = UNDER_COUNTERTOP_ADJUSTMENT;
                        rate += adjustment; // Add $25 to the rate per unit
                    }

                    const cost = parseFloat((qty * rate).toFixed(2));
                    subtotal += cost;
                    
                    // Add to rushable subtotal if it is a lineal item (core cabinetry)
                    if (item.isLineal) {
                        rushableSubtotal += cost;
                    }

                    breakdown.push({
                        name: item.name, 
                        cost: cost, 
                        qty: qty, 
                        unit: item.unit, 
                        rate: rate, // Store the adjusted rate for the receipt
                        isLineal: item.isLineal,
                        isUnderCountertops: adjustment > 0 // Tag for receipt description
                    });
                }
            };
            
            ITEM_MAP.forEach(addItem);
            
            // Lazy Susan Hardware Fee Logic (Uses RADIO buttons now)
            const isLazySusanWoodSelected = getValue('radio-lazy-susan-wood', false);
            const isLazySusanPlasticSelected = getValue('radio-lazy-susan-plastic', false);

            if (isLazySusanWoodSelected) {
                const cost = CURRENT_PRICES.lazySusanWood;
                subtotal += cost;
                breakdown.push({
                    name: 'New Lazy Susan Hardware (Wood)',
                    cost: cost, qty: 1, unit: 'PC', rate: cost, note: 'Flat rate for wood hardware replacement.', isLineal: false 
                });
            } else if (isLazySusanPlasticSelected) {
                const cost = CURRENT_PRICES.lazySusanPlastic;
                subtotal += cost;
                breakdown.push({
                    name: 'New Lazy Susan Hardware (Plastic)',
                    cost: cost, qty: 1, unit: 'PC', rate: cost, note: 'Flat rate for plastic hardware replacement.', isLineal: false
                });
            }


            // Match Fee Logic (Adds to subtotal, not rushableSubtotal)
            const isStainChecked = getValue('checkbox-stain-match', false);
            const isPaintChecked = getValue('checkbox-paint-match', false);
            const isLacquerChecked = getValue('checkbox-lacquer-match', false);
            
            let matchFeeCount = 0;
            if (isStainChecked) matchFeeCount++;
            if (isPaintChecked) matchFeeCount++;
            if (isLacquerChecked) matchFeeCount++;

            if (matchFeeCount > 0) {
                const matchFeeCost = matchFeeCount * CURRENT_PRICES.matchFee;
                subtotal += matchFeeCost;
                breakdown.push({ 
                    name: 'Color/Finish Matching Fee', 
                    cost: matchFeeCost, 
                    qty: matchFeeCount, 
                    unit: 'SERVICE', 
                    rate: CURRENT_PRICES.matchFee,
                    note: (isStainChecked ? 'Stain, ' : '') + 
                          (isPaintChecked ? 'Paint, ' : '') + 
                          (isLacquerChecked ? 'Lacquer' : ''),
                    isLineal: false
                });
                matchFeeStatusEl.textContent = `Matching fee applied: ${matchFeeCount} x $150 = ${matchFeeCost.toFixed(2)}`;
                matchFeeStatusEl.classList.remove('hidden');
            } else {
                matchFeeStatusEl.classList.add('hidden');
            }

            // Custom Flat Rate Costs (Faceframe Repair, Misc) (Adds to subtotal, not rushableSubtotal)
            const faceframeRepair = getValue('input-faceframe-repair');
            if (faceframeRepair > 0) {
                subtotal += faceframeRepair;
                breakdown.push({
                    name: 'Faceframe Repair (Custom)',
                    cost: faceframeRepair,
                    qty: 1,
                    unit: 'FLAT',
                    rate: faceframeRepair,
                    isLineal: false
                });
            }

            const miscCustom = getValue('input-misc-custom');
            if (miscCustom > 0) {
                const miscDescription = getValue('input-misc-description', false) || 'Miscellaneous Custom Work';
                subtotal += miscCustom;
                breakdown.push({
                    name: miscDescription,
                    cost: miscCustom,
                    qty: 1,
                    unit: 'FLAT',
                    rate: miscCustom,
                    isLineal: false
                });
            }

            // Rush Fee Logic (UPDATED to use rushableSubtotal)
            const isRushed = getValue('checkbox-rushed', false);
            let rushFee = 0;
            if (isRushed) {
                // Calculate rush fee based ONLY on the rushableSubtotal
                rushFee = parseFloat((rushableSubtotal * 0.50).toFixed(2)); // 50% extra
                
                // Total is subtotal (all items) + rush fee (on lineal items only)
                total = subtotal + rushFee;
                
                // Add rush fee to breakdown, referencing the base amount
                breakdown.push({
                    name: `RUSH FEE (50% of Cabinetry Subtotal: ${formatCurrency(rushableSubtotal)})`, 
                    cost: rushFee,
                    qty: 1,
                    unit: 'FLAT',
                    rate: rushFee,
                    isRushFee: true // Tag this item for special printing style
                });
            } else {
                total = subtotal;
            }

            // Payment Method Discount Logic (UPDATED FOR ROUNDING)
            const isCashSelected = getValue('payment-cash', false);
            let cashDiscount = 0;
            
            if (isCashSelected) {
                const totalPreDiscount = total; 
                const totalAfter3Percent = totalPreDiscount * 0.97;
                const finalRoundedTotal = Math.floor(totalAfter3Percent / 10) * 10;
                cashDiscount = parseFloat((totalPreDiscount - finalRoundedTotal).toFixed(2));
                total = finalRoundedTotal;
                
                // Add discount to breakdown (as a negative value item)
                breakdown.push({
                    name: 'Cash Payment Discount',
                    cost: -cashDiscount, 
                    qty: 1,
                    unit: 'DISCOUNT',
                    rate: -cashDiscount,
                    isDiscount: true 
                });
            }

            // Update Total Display
            totalCostEl.textContent = `$${total.toFixed(2)}`;
            
            // Re-render the receipt view content (passing rushableSubtotal)
            renderReceipt(breakdown, subtotal, total, isRushed, rushFee, isCashSelected, cashDiscount, rushableSubtotal);
        };
        
        // --- Receipt Rendering Function (HEAVILY MODIFIED TO MATCH SCREENSHOT) ---
        const renderReceipt = (breakdown, subtotal, total, isRushed, rushFee, isCashSelected, cashDiscount, rushableSubtotal) => {
            const companyName = getValue('company-name', false);
            const projectManager = getValue('project-manager', false);
            const jobName = getValue('job-name', false);
            const jobAddress = getValue('job-address', false);
            const clientPhone = getValue('client-phone', false);
            const quoteDate = getValue('job-date', false);
            const materialUsed = materialSelect.value;
            const finishedMaterial = finishedMaterialSelect.value;
            
            // Determine lead time status
            const leadTime = isRushed ? '<span class="text-red-600 font-bold">RUSHED ORDER (4-Day)</span>' : 'Standard Lead Time';
            // Determine finished material display
            const finishedMaterialDisplay = (finishedMaterial && finishedMaterial.toLowerCase() !== 'almond' && finishedMaterial.toLowerCase() !== 'hardrock') 
                                            ? finishedMaterial : 'MDF';
            
            // Helper function to render a breakdown section
            const renderSectionItems = (items) => {
                let html = '';
                items.forEach(item => {
                    if (item.cost === 0 && !item.isRushFee && !item.isDiscount) return; // Skip zero-cost items (except fees/discounts)
                    if (item.isRushFee || item.isDiscount) return; // Fees/discounts handled separately

                    // Determine quantity display format
                    let qtyDisplay;
                    
                    if (item.unit === 'ft') {
                        // Example: 3.75 ft @ $90.00 / ft
                        qtyDisplay = `${item.qty.toFixed(2).replace(/\.00$/, '')} ${item.unit} @ $${formatCurrency(item.rate)} / ${item.unit}`;
                    } else if (item.unit === 'PC' || item.unit === 'SET') {
                        // Example: 1 PC @ $30.00 / PC
                        qtyDisplay = `${item.qty} ${item.unit} @ $${formatCurrency(item.rate)} / ${item.unit}`;
                    } else if (item.unit === 'SERVICE') {
                        // Example: 3 SERVICE @ $150.00 / SERVICE (for matching fee)
                        qtyDisplay = `${item.qty} SERVICE @ $${formatCurrency(item.rate)} / SERVICE`;
                    } else if (item.unit === 'FLAT') {
                        // Example: Custom Flat Rate Description
                        qtyDisplay = item.rate === item.cost ? 'Custom Flat Rate' : `$${formatCurrency(item.rate)}`;
                    } else {
                        qtyDisplay = item.qty;
                    }

                    
                    if (item.isLineal) {
                        // Style for Lineal items (Name, then Qty/Rate below)
                        html += `
                            <div class="receipt-line-item">
                                <div class="flex-1 mr-4">
                                    <p class="font-medium text-primary-dark">
                                        ${item.name}
                                        ${item.isUnderCountertops ? '<span class="text-xs font-semibold text-accent ml-2">(+ Under Countertops Fee)</span>' : ''}
                                    </p>
                                    <p class="text-xs text-gray-600">${qtyDisplay}</p>
                                </div>
                                <span class="font-bold price-display">$${formatCurrency(item.cost)}</span>
                            </div>
                        `;
                    } else {
                        // Style for Hardware/Accessories/Flat Rate (Qty/Rate on the first line, then cost)
                        html += `
                            <div class="receipt-line-item">
                                <div class="flex-1 mr-4">
                                    <p class="font-medium text-primary-dark">
                                        ${item.name}
                                        <span class="text-xs text-gray-600 font-normal ml-2">${qtyDisplay}</span>
                                    </p>
                                </div>
                                <span class="font-bold price-display">$${formatCurrency(item.cost)}</span>
                            </div>
                        `;
                    }
                });
                return html;
            };

            // 1. Separate Breakdown into Lineal and Accessories
            const linealItems = breakdown.filter(item => item.isLineal && item.cost > 0);
            
            // Accessories, including lazy susans, fees, and flat custom work.
            const accessoryItems = breakdown.filter(item => !item.isLineal && item.cost > 0 && !item.isRushFee && !item.isDiscount);

            // 2. Find Fees
            const rushFeeItem = breakdown.find(item => item.isRushFee);
            const cashDiscountItem = breakdown.find(item => item.isDiscount); 
            
            const receiptHTML = `
                <div class="p-8 max-w-2xl mx-auto bg-white min-h-screen"> 
                    <header class="text-center mb-6">
                        <h1 class="text-2xl font-extrabold text-primary-dark mb-2">Neff Enterprises Inc.</h1>
                        <div class="text-base font-normal text-primary-dark leading-snug mb-6">
                            <p>P.O. Box 2522</p>
                            <p>Gilbert, AZ 85299-2522</p>
                            <p>ROC 120032</p>
                            <p>480-688-7978</p>
                        </div>
                        
                        <p class="text-base font-semibold text-primary-dark border-b-2 border-gray-200 pb-3 mb-6">Cabinet Rebuild Estimate</p>
                    </header>
                    
                    <div class="grid grid-cols-2 gap-y-1 gap-x-6 text-left text-sm mb-6">
                        <div>
                            <p><span class="font-bold">Company:</span> ${companyName || 'TBD'}</p>
                            <p><span class="font-bold">Project Manager:</span> ${projectManager || 'TBD'}</p>
                            <p><span class="font-bold">Job Name:</span> ${jobName || 'TBD'}</p>
                            <p><span class="font-bold">Address:</span> ${jobAddress || 'TBD'}</p>
                        </div>
                        <div>
                            <p><span class="font-bold">Project Mgr Phone:</span> ${clientPhone || 'TBD'}</p>
                            <p><span class="font-bold">Quote Date:</span> ${quoteDate || 'TBD'}</p>
                            <p><span class="font-bold">Box Material:</span> ${materialUsed || 'Hardrock Maple'}</p>
                            <p><span class="font-bold">Finished Material:</span> ${finishedMaterialDisplay || 'MDF'}</p>
                            <p><span class="font-bold">Lead Time:</span> ${leadTime}</p>
                        </div>
                    </div>

                    ${linealItems.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="receipt-section-header">Cabinetry & Shelving (Lineal Feet)</h3>
                            <div class="space-y-1">
                                ${renderSectionItems(linealItems)}
                            </div>
                        </div>
                    ` : ''}

                    ${accessoryItems.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="receipt-section-header">Hardware & Accessory Pieces</h3>
                            <div class="space-y-1">
                                ${renderSectionItems(accessoryItems)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-between items-center text-xl font-bold text-primary-dark p-2 border-t border-b border-gray-300">
                        <span>Subtotal (Before Fees/Discounts)</span>
                        <span class="font-bold price-display">$${formatCurrency(subtotal)}</span>
                    </div>

                    ${rushFeeItem ? `
                        <div class="flex justify-between items-center text-red-600 font-bold p-2 is-rush-fee">
                            <span>RUSH FEE (50% of Cabinetry Lineal Items: $${formatCurrency(rushableSubtotal)})</span>
                            <span class="price-display">$${formatCurrency(rushFee)}</span>
                        </div>
                    ` : ''}

                    ${cashDiscountItem ? `
                        <div class="flex justify-between items-center text-green-700 font-bold p-2 is-discount">
                            <span>Cash Payment Discount</span>
                            <span class="price-display">$${formatCurrency(cashDiscountItem.cost)}</span>
                        </div>
                    ` : ''}

                    <div class="receipt-total-bar flex justify-between items-center text-2xl font-extrabold text-accent p-3 mt-4 rounded-lg">
                        <span>GRAND TOTAL:</span>
                        <span id="receipt-grand-total" class="price-display text-2xl">$${formatCurrency(total)}</span>
                    </div>

                    <div class="mt-16 pt-4">
                        <p class="text-sm text-gray-700 italic text-center mb-8">
                            This quote is subject to the terms and conditions outlined above.
                        </p>
                        
                        <div class="grid grid-cols-2 gap-10 mb-8">
                            <div>
                                <p class="border-b border-black w-full h-10"></p>
                                <span class="block text-center text-gray-600 text-sm italic">Client Signature</span>
                            </div>
                            <div>
                                <p class="border-b border-black w-full h-10"></p>
                                <span class="block text-center text-gray-600 text-sm italic">Date</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-10 mt-4">
                            <div>
                                <p class="border-b border-black w-full h-10"></p>
                                <span class="block text-center text-gray-600 text-sm italic">Printed Name</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            receiptContainer.innerHTML = receiptHTML;
        };


        // --- Initialization and Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set today's date automatically
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            jobDateInput.value = `${yyyy}-${mm}-${dd}`;
            
            // Attach event listeners to all relevant inputs for real-time calculation
            inputElements.forEach(input => {
                // Input listener for text/number/date, change listener for select/checkbox/radio
                input.addEventListener(input.type === 'checkbox' || input.type === 'radio' || input.tagName === 'SELECT' ? 'change' : 'input', calculateTotal); 
            });

            // Add button functionality
            printBtn.addEventListener('click', () => {
                if (!printBtn.disabled) window.print();
            });

            // Initial setup: Apply default pricing and perform initial calculation
            applyMaterialPricing();
        });
    </script>
</body>
</html>
